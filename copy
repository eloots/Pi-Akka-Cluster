#!/bin/bash

######################################################################
#
# Copy binaries for a given exercise to all nodes or a specific single node
#
# Usage:
#   ./copy exercise_nr [node-nr]
#
# Set CLUSTER_NR to the number of the cluster you're working with
# Default value of CLUSTER_NR is 0
######################################################################

RED='\033[1;31m'
GREEN='\033[1;32m'
RESET='\033[0m' # No Color

printError()
{
  echo -e "${RED}$@${RESET}"
}

printGreen()
{
  echo -e "${GREEN}$@${RESET}"
}

CLUSTER_NR_SEL=${CLUSTER_NR:-0}

CLUSTER_BASE_NODE_NR=$[ $CLUSTER_NR_SEL * 5 ]

PI_USER=akkapi

EXERCISE_NR=`printf %03d $1 2>/dev/null`

# The artefact for an exercise is a zip file generated by the native packager
ZipFileFQN=`ls exercise*${EXERCISE_NR}*/target/universal/exercise*${EXERCISE_NR}*zip 2>/dev/null`

# Check if an exercise was found with the given number, otherwise exit
if [ "Empty$ZipFileFQN" == "Empty" ]; then
  echo "No exercise found with exercise number $1"
  exit -1
fi

eval IFS=/ read dum dum dum ZipFile <<< $ZipFileFQN
exName=$(echo $ZipFile | sed -e 's/.zip//')

ALL_NODES="0 1 2 3 4"
SELECTED_NODE=$2
NODES=${SELECTED_NODE:-$ALL_NODES}

# All exercise artefacts are stored in a folder "exercises" on the nodes
NodeExerciseBaseFolder=/home/${PI_USER}/exercises

for i in $NODES;do
  node=$[ CLUSTER_BASE_NODE_NR + i ]
  account=${PI_USER}@node-${node}
  if [ ! $(ssh $account command -v unzip) ];then
    printError "ERROR: The 'unzip' command is missing on node-${node}: install it first by running the following command on node-${node}:"
    printError "          sudo apt-get install -y unzip"
  else
    ssh $account mkdir -p $NodeExerciseBaseFolder
    printGreen "Copy $ZipFile to node-$node"
    scp $ZipFileFQN $account:$NodeExerciseBaseFolder
    ssh $account rm -rf $NodeExerciseBaseFolder/$exName
    echo "Unzipping archive"
    ssh $account "cd $NodeExerciseBaseFolder; (unzip $ZipFile > /dev/null && rm $ZipFile)" &
  fi
done
