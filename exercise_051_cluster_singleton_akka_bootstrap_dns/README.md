# Cluster Bootstrap / Discovery via akka-dns

This exercise demonstrates using Akka Management Cluster Bootstrap
to do discovery via DNS rather than using the seed node method.

We will serve DNS records to see this configuration in action using `dnsmasq`.
`dnsmasq` can be configured to serve DNS records for a specific [local] domain. It can serve `A` and `SRV` records (amongst others) which is useful in our case.

In order to try this out yourself on a Mac, install `dnsmasq` as follows:

```scala
$ brew install dnsmasq
$ mkdir -p /usr/local/etc/dnsmasq.d
$ touch /usr/local/etc/dnsmasq.d/development.conf
```

Add the following single line to `/usr/local/etc/dnsmasq.conf`:

```scala
conf-dir=/usr/local/etc/dnsmasq.d,*.conf
```

Now, we are ready to add a `dnsmasq` DNS configuration section to `/usr/local/etc/dnsmasq.d/development.conf`:

```scala
$ cat /usr/local/etc/dnsmasq.d/development.conf
local=/lb.com/

# Three SRV records for Akka Cluster Discovery
#srv-host=_management._tcp.picluster.lb.com,node-2,8558,1
#srv-host=_management._tcp.picluster.lb.com,node-3,8558,1
#srv-host=_management._tcp.picluster.lb.com,node-4,8558,1
```

1) Start `dnsmasq` by running the following command (you may have to supply your user password):

```scala
$ sudo brew services restart dnsmasq
==> Successfully started `dnsmasq` (label: homebrew.mxcl.dnsmasq)
```

Note the three lines at the bottom: when removing the comment sign `#`, these will add `SRV` records for the `_management._tcp.picluster.lb.com` domain.

You will notice the configuration has changed in the `application.conf` file. 

For starters, we specify that we are going to do Discovery via `akka-dns`:

```scala
akka {
   
   discovery.method = akka-dns
   
```

There's a section that is used to describe the bootstrap setup which 
requires the service name and the discovery method. 

```scala
management.cluster.bootstrap.contact-point-discovery {
    required-contact-point-nr = 3
    
    service-name              = "picluster.lb.com"
    protocol                  = "tcp"
    port-name                 = "management"
  }
```

When, as in this config, the `protocol` and `port-name` settings are specified, Akka Discovery will look for `SRV` records to determine the end-points.

We need to make one last change to our configuration on the nodes to make them resolve DNS queries via our `dnsmasq` intermediate DNS server. First look up the IP address of your laptop. For the sake of demonstration, suppose that this is `192.168.200.100`. Now, on every node, edit the `/etc/resolv.conf` file to show the following content:

```scala
$ cat /etc/resolv.conf
# Generated by dhcpcd from eth0.dhcp
# /etc/resolv.conf.head can replace this line
nameserver 192.168.200.100
```

> Note: this file is auto-generated - so, the original content will be restored
>       when you reboot the node(s).



Try the following steps:

 
1) Build the exercise by running `sbt exercise_051_.../assembly`

2) Copy the jar onto the Pi cluster nodes by running `./copy 51`

3) Start the application on `node-2`, `node-3` and `node-4`

- does the cluster form?

4) Uncomment the last line in `/usr/local/etc/dnsmasq.d/development.conf` to show the following content:

```scala
$ cat /usr/local/etc/dnsmasq.d/development.conf
local=/lb.com/

# Three SRV records for Akka Cluster Discovery
#srv-host=_management._tcp.picluster.lb.com,node-2,8558,1
#srv-host=_management._tcp.picluster.lb.com,node-3,8558,1
srv-host=_management._tcp.picluster.lb.com,node-4,8558,1
```
- Restart `dnsmasq` to pick-up the changed configuration.
- does the cluster form?

5) repeat step 4) by uncommenting the line with the SRV record for `node-3` and restart `dnsmasq`. Observe what happens.

6) repeat again with the last three lines uncommented:

```scala
$ cat /usr/local/etc/dnsmasq.d/development.conf
local=/lb.com/

# Three SRV records for Akka Cluster Discovery
srv-host=_management._tcp.picluster.lb.com,node-2,8558,1
srv-host=_management._tcp.picluster.lb.com,node-3,8558,1
srv-host=_management._tcp.picluster.lb.com,node-4,8558,1
```

- Restart `dnsmasq` to pick-up the changed configuration.
- does the cluster form?

There are other configuration keys available for the cluster bootstrap settings. 
```
[service-namespace, protocol, exponential-backoff-max, resolve-timeout, effective-name, 
stable-margin, interval, required-contact-point-nr, port-name, exponential-backoff-random-factor]
```
> For more details on the other settings, see API documentation

For more information on akka management cluster bootstrap, 
please visit [Akka management cluster bootstrap documentation](https://developer.lightbend.com/docs/akka-management/current/bootstrap/index.html])

  